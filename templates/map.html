{% extends "base.html" %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
    }

    .map-controls-right {
        display: flex;
        gap: 8px;
    }

    .map-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 24px;
        height: calc(100vh - 200px);
    }

    .map-legend {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
    }

    .map-legend h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-section {
        margin-bottom: 20px;
    }

    .legend-section h4 {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 12px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .legend-color {
        width: 32px;
        height: 12px;
        border-radius: 2px;
    }

    .legend-color.great { background: rgb(46, 125, 50); }
    .legend-color.good { background: rgb(25, 118, 210); }
    .legend-color.fair { background: rgb(237, 108, 2); }
    .legend-color.poor { background: rgb(211, 47, 47); }

    .legend-label {
        font-size: 14px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }

    .stat-row:last-child {
        border-bottom: none;
    }

    .stat-label {
        color: var(--muted-fg);
    }

    .stat-value {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    .map-container-card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        height: 100%;
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    /* Leaflet popup custom styling */
    .custom-popup .leaflet-popup-content-wrapper {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 0;
    }

    .popup-content {
        padding: 16px;
    }

    .popup-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .popup-section {
        margin-bottom: 12px;
    }

    .popup-section h4 {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--muted-fg);
    }

    .popup-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 4px;
    }

    .popup-row span:first-child {
        color: var(--muted-fg);
    }

    .popup-row span:last-child {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    @media (max-width: 1024px) {
        .map-layout {
            grid-template-columns: 1fr;
            height: auto;
        }

        .map-legend {
            height: auto;
        }

        .map-container-card {
            height: 500px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-controls">
    <div class="page-header" style="margin-bottom: 0;">
        <h1>Pipe Network Map</h1>
        <p>Interactive visualization of wastewater infrastructure</p>
    </div>
    <div class="map-controls-right">
        <button class="btn" onclick="zoomIn()">
            <i class="fas fa-plus"></i>
        </button>
        <button class="btn" onclick="zoomOut()">
            <i class="fas fa-minus"></i>
        </button>
        <button class="btn" onclick="resetView()">
            <i class="fas fa-expand"></i>
        </button>
    </div>
</div>

<div class="map-layout">
    <!-- Map Legend -->
    <div class="map-legend">
        <h3>
            <i class="fas fa-layer-group"></i>
            Map Legend
        </h3>

        <div class="legend-section">
            <h4>Pipe Quality</h4>
            <div class="legend-item">
                <div class="legend-color great"></div>
                <span class="legend-label">Great</span>
            </div>
            <div class="legend-item">
                <div class="legend-color good"></div>
                <span class="legend-label">Good</span>
            </div>
            <div class="legend-item">
                <div class="legend-color fair"></div>
                <span class="legend-label">Fair</span>
            </div>
            <div class="legend-item">
                <div class="legend-color poor"></div>
                <span class="legend-label">Poor</span>
            </div>
        </div>

        <div class="legend-section">
            <h4>System Stats</h4>
            <div id="map-stats">
                Loading...
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="map-container-card">
        <div id="map"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map;
    let pipeSegments = [];
    let markers = [];

    const qualityColors = {
        'Great': '#2e7d32',
        'Good': '#1976d2',
        'Fair': '#ed6c02',
        'Poor': '#d32f2f'
    };

    async function initMap() {
        // Initialize map centered on Ann Arbor
        map = L.map('map').setView([42.2808, -83.7430], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Load pipe segments
        const response = await fetch('/api/pipe-segments');
        pipeSegments = await response.json();

        // Update stats
        updateStats();

        // Add pipe segments to map
        pipeSegments.forEach(pipe => {
            const color = qualityColors[pipe.quality];
            const opacity = pipe.quality === 'Poor' ? 0.9 : 0.7;

            // Create circle marker for each pipe
            const marker = L.circleMarker([pipe.latitude, pipe.longitude], {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: opacity
            }).addTo(map);

            // Create popup content
            const popupContent = createPopupContent(pipe);
            marker.bindPopup(popupContent, {
                className: 'custom-popup',
                maxWidth: 300
            });

            // Add pulse effect for poor quality pipes
            if (pipe.quality === 'Poor') {
                marker.on('add', function() {
                    setTimeout(() => {
                        marker.setStyle({ fillOpacity: 0.4 });
                        setTimeout(() => marker.setStyle({ fillOpacity: 0.9 }), 500);
                    }, 500);
                });
            }

            markers.push(marker);
        });

        // Add alert markers for poor quality pipes
        const poorPipes = pipeSegments.filter(p => p.quality === 'Poor');
        poorPipes.forEach(pipe => {
            const alertIcon = L.divIcon({
                className: 'alert-marker',
                html: '<i class="fas fa-exclamation-triangle" style="color: #d32f2f; font-size: 20px;"></i>',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });

            L.marker([pipe.latitude, pipe.longitude], { icon: alertIcon })
                .addTo(map)
                .bindTooltip(`Alert: ${pipe.name}`, { permanent: false });
        });
    }

    function createPopupContent(pipe) {
        return `
            <div class="popup-content">
                <div class="popup-header">
                    <i class="fas fa-map-marker-alt"></i>
                    ${pipe.name}
                </div>
                <div class="popup-section">
                    <span class="badge badge-${pipe.quality.toLowerCase()}">${pipe.quality} Quality</span>
                </div>
                <div class="popup-section">
                    <h4>Location</h4>
                    <div class="popup-row">
                        <span>Latitude</span>
                        <span>${pipe.latitude.toFixed(6)}</span>
                    </div>
                    <div class="popup-row">
                        <span>Longitude</span>
                        <span>${pipe.longitude.toFixed(6)}</span>
                    </div>
                </div>
                <div class="popup-section">
                    <h4>Specifications</h4>
                    <div class="popup-row">
                        <span>Type</span>
                        <span>${pipe.pipeType}</span>
                    </div>
                    <div class="popup-row">
                        <span>Length</span>
                        <span>${pipe.lengthMeters} m</span>
                    </div>
                    <div class="popup-row">
                        <span>Diameter</span>
                        <span>${pipe.diameter} mm</span>
                    </div>
                    <div class="popup-row">
                        <span>Age</span>
                        <span>${pipe.estimatedAge} years</span>
                    </div>
                    <div class="popup-row">
                        <span>Durability</span>
                        <span>${pipe.durabilityScore}/100</span>
                    </div>
                </div>
                <div class="popup-section">
                    <h4>Last Inspection</h4>
                    <div style="font-size: 13px; color: var(--muted-fg);">
                        ${new Date(pipe.lastInspectionDate).toLocaleDateString()}
                    </div>
                </div>
            </div>
        `;
    }

    function updateStats() {
        const greatCount = pipeSegments.filter(p => p.quality === 'Great').length;
        const poorCount = pipeSegments.filter(p => p.quality === 'Poor').length;

        document.getElementById('map-stats').innerHTML = `
            <div class="stat-row">
                <span class="stat-label">Total Segments</span>
                <span class="stat-value">${pipeSegments.length}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Great Quality</span>
                <span class="stat-value" style="color: var(--chart-3);">${greatCount}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Poor Quality</span>
                <span class="stat-value" style="color: var(--destructive);">${poorCount}</span>
            </div>
        `;
    }

    function zoomIn() {
        map.zoomIn();
    }

    function zoomOut() {
        map.zoomOut();
    }

    function resetView() {
        map.setView([42.2808, -83.7430], 13);
    }

    // Initialize map when page loads
    initMap();
</script>
{% endblock %}