{% extends "base.html" %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
    }

    .map-controls-right {
        display: flex;
        gap: 8px;
    }

    .map-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 24px;
        height: calc(100vh - 320px);
        margin-bottom: 24px;
    }

    .map-legend {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
    }

    .map-legend h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-section {
        margin-bottom: 20px;
    }

    .legend-section:last-child {
        margin-bottom: 0;
    }

    .legend-section h4 {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 12px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .legend-color {
        width: 32px;
        height: 12px;
        border-radius: 2px;
    }

    .legend-color.great { background: rgb(46, 125, 50); }
    .legend-color.good { background: rgb(25, 118, 210); }
    .legend-color.fair { background: rgb(237, 108, 2); }
    .legend-color.poor { background: rgb(211, 47, 47); }

    .legend-label {
        font-size: 14px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }

    .stat-row:last-child {
        border-bottom: none;
    }

    .stat-label {
        color: var(--muted-fg);
    }

    .stat-value {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    /* Active Alerts Section - Full Width */
    .alerts-section {
        width: 100%;
    }

    .alerts-card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 24px;
    }

    .alerts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .alerts-card h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .alerts-count {
        font-size: 14px;
        color: var(--muted-fg);
        font-weight: normal;
    }

    .alerts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 12px;
    }

    .alert-item {
        padding: 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--background);
    }

    .alert-item:hover {
        background: var(--muted);
        border-color: var(--primary);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .alert-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .alert-segment {
        font-size: 14px;
        font-weight: 600;
        flex: 1;
    }

    .alert-pacp {
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 600;
        padding: 3px 6px;
        background: rgba(25, 118, 210, 0.1);
        color: var(--primary);
        border-radius: 3px;
        margin-left: auto;
    }

    .alert-message {
        font-size: 13px;
        color: var(--muted-fg);
        margin-bottom: 8px;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .alert-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
    }

    .alert-time {
        font-size: 12px;
        color: var(--muted-fg);
        font-family: var(--font-mono);
    }

    .alert-action {
        font-size: 12px;
        color: var(--primary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .alert-action i {
        font-size: 10px;
    }

    .alert-confidence {
        font-size: 11px;
        font-family: var(--font-mono);
        padding: 3px 6px;
        border-radius: 3px;
        font-weight: 600;
    }

    .alert-confidence.high {
        background: rgba(46, 125, 50, 0.15);
        color: #2e7d32;
    }

    .alert-confidence.medium {
        background: rgba(237, 108, 2, 0.15);
        color: #ed6c02;
    }

    .no-alerts {
        text-align: center;
        padding: 48px;
        color: var(--muted-fg);
        font-size: 14px;
    }

    .no-alerts i {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    .map-container-card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        height: 100%;
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    /* Leaflet popup custom styling */
    .custom-popup .leaflet-popup-content-wrapper {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 0;
    }

    .popup-content {
        padding: 16px;
    }

    .popup-header {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .popup-section {
        margin-bottom: 12px;
    }

    .popup-section h4 {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--muted-fg);
    }

    .popup-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 4px;
    }

    .popup-row span:first-child {
        color: var(--muted-fg);
    }

    .popup-row span:last-child {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    @media (max-width: 1024px) {
        .map-layout {
            grid-template-columns: 1fr;
            height: auto;
        }

        .map-legend {
            height: auto;
            max-height: 300px;
        }

        .map-container-card {
            height: 500px;
        }

        .alerts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-controls">
    <div class="page-header" style="margin-bottom: 0;">
        <h1>Pipe Network Map</h1>
        <p>Interactive visualization of wastewater infrastructure</p>
    </div>
    <div class="map-controls-right">
        <button class="btn btn-secondary" onclick="exportGISData()">
            <i class="fas fa-map-marked-alt"></i>
            Export GIS Data
        </button>
        <button class="btn btn-secondary" onclick="exportPACPReport()">
            <i class="fas fa-file-csv"></i>
            Export PACP Report
        </button>
        <button class="btn" onclick="zoomIn()">
            <i class="fas fa-plus"></i>
        </button>
        <button class="btn" onclick="zoomOut()">
            <i class="fas fa-minus"></i>
        </button>
        <button class="btn" onclick="resetView()">
            <i class="fas fa-expand"></i>
        </button>
    </div>
</div>

<div class="map-layout">
    <!-- Map Legend -->
    <div class="map-legend">
        <h3>
            <i class="fas fa-layer-group"></i>
            Map Legend
        </h3>

        <div class="legend-section">
            <h4>Pipe Quality</h4>
            <div class="legend-item">
                <div class="legend-color great"></div>
                <span class="legend-label">Great</span>
            </div>
            <div class="legend-item">
                <div class="legend-color good"></div>
                <span class="legend-label">Good</span>
            </div>
            <div class="legend-item">
                <div class="legend-color fair"></div>
                <span class="legend-label">Fair</span>
            </div>
            <div class="legend-item">
                <div class="legend-color poor"></div>
                <span class="legend-label">Poor</span>
            </div>
        </div>

        <div class="legend-section">
            <h4>System Stats</h4>
            <div id="map-stats">
                Loading...
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="map-container-card">
        <div id="map"></div>
    </div>
</div>

<!-- Active Alerts - Full Width Below -->
<div class="alerts-section">
    <div class="alerts-card">
        <div class="alerts-header">
            <h3>
                <i class="fas fa-exclamation-triangle"></i>
                Active Alerts
                <span class="alerts-count" id="alerts-count"></span>
            </h3>
        </div>
        <div class="alerts-grid" id="alerts-list">
            Loading...
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map;
    let pipeSegments = [];
    let alerts = [];
    let markers = [];

    const qualityColors = {
        'Great': '#2e7d32',
        'Good': '#1976d2',
        'Fair': '#ed6c02',
        'Poor': '#d32f2f'
    };

    const severityConfig = {
        critical: { icon: 'fa-exclamation-triangle', badge: 'badge-critical' },
        high: { icon: 'fa-exclamation-triangle', badge: 'badge-high' },
        medium: { icon: 'fa-clock', badge: 'badge-medium' },
        low: { icon: 'fa-check-circle', badge: 'badge-low' }
    };

    async function initMap() {
        // Initialize map centered on Ann Arbor
        map = L.map('map').setView([42.2808, -83.7430], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Load data
        const [segmentsRes, alertsRes] = await Promise.all([
            fetch('/api/pipe-segments'),
            fetch('/api/alerts')
        ]);

        pipeSegments = await segmentsRes.json();
        alerts = await alertsRes.json();

        // Update stats
        updateStats();

        // Render alerts
        renderAlerts();

        // Add pipe segments to map
        pipeSegments.forEach(pipe => {
            const color = qualityColors[pipe.quality];
            const opacity = pipe.quality === 'Poor' ? 0.9 : 0.7;

            // Create circle marker for each pipe
            const marker = L.circleMarker([pipe.latitude, pipe.longitude], {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: opacity
            }).addTo(map);

            // Create popup content
            const popupContent = createPopupContent(pipe);
            marker.bindPopup(popupContent, {
                className: 'custom-popup',
                maxWidth: 300
            });

            // Add pulse effect for poor quality pipes
            if (pipe.quality === 'Poor') {
                marker.on('add', function() {
                    setTimeout(() => {
                        marker.setStyle({ fillOpacity: 0.4 });
                        setTimeout(() => marker.setStyle({ fillOpacity: 0.9 }), 500);
                    }, 500);
                });
            }

            markers.push(marker);
        });

        // Add alert markers for poor quality pipes
        const poorPipes = pipeSegments.filter(p => p.quality === 'Poor');
        poorPipes.forEach(pipe => {
            const alertIcon = L.divIcon({
                className: 'alert-marker',
                html: '<i class="fas fa-exclamation-triangle" style="color: #d32f2f; font-size: 20px;"></i>',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });

            L.marker([pipe.latitude, pipe.longitude], { icon: alertIcon })
                .addTo(map)
                .bindTooltip(`Alert: ${pipe.name}`, { permanent: false });
        });
    }

    function createPopupContent(pipe) {
        return `
            <div class="popup-content">
                <div class="popup-header">
                    <i class="fas fa-map-marker-alt"></i>
                    ${pipe.name}
                </div>
                <div class="popup-section">
                    <span class="badge badge-${pipe.quality.toLowerCase()}">${pipe.quality} Quality</span>
                </div>
                <div class="popup-section">
                    <h4>Location</h4>
                    <div class="popup-row">
                        <span>Latitude</span>
                        <span>${pipe.latitude.toFixed(6)}</span>
                    </div>
                    <div class="popup-row">
                        <span>Longitude</span>
                        <span>${pipe.longitude.toFixed(6)}</span>
                    </div>
                </div>
                <div class="popup-section">
                    <h4>Specifications</h4>
                    <div class="popup-row">
                        <span>Type</span>
                        <span>${pipe.pipeType}</span>
                    </div>
                    <div class="popup-row">
                        <span>Length</span>
                        <span>${pipe.lengthMeters} m</span>
                    </div>
                    <div class="popup-row">
                        <span>Diameter</span>
                        <span>${pipe.diameter} mm</span>
                    </div>
                    <div class="popup-row">
                        <span>Age</span>
                        <span>${pipe.estimatedAge} years</span>
                    </div>
                    <div class="popup-row">
                        <span>Durability</span>
                        <span>${pipe.durabilityScore}/100</span>
                    </div>
                </div>
                <div class="popup-section">
                    <h4>Last Inspection</h4>
                    <div style="font-size: 13px; color: var(--muted-fg);">
                        ${new Date(pipe.lastInspectionDate).toLocaleDateString()}
                    </div>
                </div>
            </div>
        `;
    }

    function updateStats() {
        const greatCount = pipeSegments.filter(p => p.quality === 'Great').length;
        const poorCount = pipeSegments.filter(p => p.quality === 'Poor').length;

        document.getElementById('map-stats').innerHTML = `
            <div class="stat-row">
                <span class="stat-label">Total Segments</span>
                <span class="stat-value">${pipeSegments.length}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Great Quality</span>
                <span class="stat-value" style="color: var(--chart-3);">${greatCount}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Poor Quality</span>
                <span class="stat-value" style="color: var(--destructive);">${poorCount}</span>
            </div>
        `;
    }

    function renderAlerts() {
        const alertsList = document.getElementById('alerts-list');
        const alertsCount = document.getElementById('alerts-count');

        if (!alerts || alerts.length === 0) {
            alertsList.innerHTML = `
                <div class="no-alerts">
                    <i class="fas fa-check-circle"></i>
                    <div>No active alerts</div>
                </div>
            `;
            alertsCount.textContent = '(0)';
            return;
        }

        // Sort by severity
        const sortedAlerts = [...alerts].sort((a, b) => {
            const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
            return severityOrder[b.severity] - severityOrder[a.severity];
        });

        alertsCount.textContent = `(${sortedAlerts.length})`;

        alertsList.innerHTML = sortedAlerts.map(alert => {
            const config = severityConfig[alert.severity];
            
            // Find the pipe for this alert to zoom to it
            const pipe = pipeSegments.find(p => p.id === alert.pipeSegmentId);
            
            // Confidence badge
            const confidencePercent = (alert.confidence * 100).toFixed(0);
            const confidenceClass = alert.confidence > 0.85 ? 'high' : 'medium';
            
            return `
                <div class="alert-item" onclick='zoomToAlert(${JSON.stringify(pipe)})'>
                    <div class="alert-header">
                        <span class="badge ${config.badge}">
                            <i class="fas ${config.icon}"></i>
                            ${alert.severity.toUpperCase()}
                        </span>
                        <span class="alert-segment">${alert.pipeSegmentName}</span>
                        <span class="alert-pacp">PACP: ${alert.pacp_code}</span>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-footer">
                        <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="alert-confidence ${confidenceClass}">${confidencePercent}% ✓</span>
                            <div class="alert-action">
                                View on map <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function zoomToAlert(pipe) {
        if (pipe && pipe.latitude && pipe.longitude) {
            map.setView([pipe.latitude, pipe.longitude], 16);
            
            // Find and open the popup for this pipe
            markers.forEach(marker => {
                const latlng = marker.getLatLng();
                if (Math.abs(latlng.lat - pipe.latitude) < 0.0001 && 
                    Math.abs(latlng.lng - pipe.longitude) < 0.0001) {
                    marker.openPopup();
                }
            });
        }
    }

    function zoomIn() {
        map.zoomIn();
    }

    function zoomOut() {
        map.zoomOut();
    }

    function resetView() {
        map.setView([42.2808, -83.7430], 13);
    }

    function exportGISData() {
        // Export as GeoJSON
        const geojson = {
            "type": "FeatureCollection",
            "features": pipeSegments.map(pipe => ({
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [pipe.longitude, pipe.latitude]
                },
                "properties": {
                    "segment": pipe.name,
                    "quality": pipe.quality,
                    "pipe_type": pipe.pipeType,
                    "diameter": pipe.diameter,
                    "age": pipe.estimatedAge,
                    "durability": pipe.durabilityScore
                }
            }))
        };

        const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pipevision-gis-data.geojson';
        a.click();
        window.URL.revokeObjectURL(url);

        alert('✅ GIS Data Exported!\n\nFormat: GeoJSON\nCompatible with: ArcGIS, QGIS, Leaflet\n\nFile includes all pipe locations and metadata.');
    }

    function exportPACPReport() {
        // Export alerts with PACP codes
        const headers = ['Segment', 'Date', 'Severity', 'PACP_Code', 'PACP_Score', 'Message', 'Confidence', 'Latitude', 'Longitude'];
        
        const rows = alerts.map(alert => {
            const pipe = pipeSegments.find(p => p.id === alert.pipeSegmentId);
            return [
                alert.pipeSegmentName,
                new Date(alert.timestamp).toISOString().split('T')[0],
                alert.severity,
                alert.pacp_code,
                alert.pacp_score,
                `"${alert.message}"`,
                (alert.confidence * 100).toFixed(2),
                pipe ? pipe.latitude : '',
                pipe ? pipe.longitude : ''
            ];
        });

        const csv = [
            '# PipeVision PACP Report',
            '# Generated: ' + new Date().toISOString(),
            '# PACP 7.0 Compliant',
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pipevision-pacp-report.csv';
        a.click();
        window.URL.revokeObjectURL(url);

        alert('✅ PACP Report Exported!\n\nFormat: CSV with PACP codes\nReady for: ARGON import\n\nIncludes GPS coordinates for GIS mapping.');
    }

    // Initialize map when page loads
    initMap();
</script>
{% endblock %}