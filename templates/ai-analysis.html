{% extends "base.html" %}

{% block extra_styles %}
<style>
    .page-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
    }

    .filters-section {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .filters-section h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .filter-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .filter-item label {
        font-size: 14px;
        cursor: pointer;
        user-select: none;
    }

    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-top: 24px;
    }

    .analysis-card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
    }

    .analysis-card h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .analysis-card > p {
        font-size: 13px;
        color: var(--muted-fg);
        margin-bottom: 16px;
    }

    .accordion {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .accordion-item {
        border-bottom: 1px solid var(--border);
    }

    .accordion-item:last-child {
        border-bottom: none;
    }

    .accordion-header {
        padding: 16px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .accordion-header:hover {
        background: var(--muted);
    }

    .accordion-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .accordion-title {
        font-size: 14px;
        font-weight: 500;
    }

    .pacp-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
    }

    .pacp-code {
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        background: rgba(25, 118, 210, 0.1);
        color: var(--primary);
        border-radius: 4px;
    }

    .pacp-score {
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        background: var(--muted);
        border-radius: 4px;
    }

    .confidence-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        font-family: var(--font-mono);
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .confidence-badge.high {
        background: rgba(46, 125, 50, 0.15);
        color: #2e7d32;
    }

    .confidence-badge.medium {
        background: rgba(237, 108, 2, 0.15);
        color: #ed6c02;
    }

    .confidence-badge.low {
        background: rgba(198, 40, 40, 0.15);
        color: #c62828;
    }

    .accordion-icon {
        transition: transform 0.2s;
    }

    .accordion-icon.open {
        transform: rotate(180deg);
    }

    .accordion-content {
        padding: 0 16px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .accordion-content.open {
        max-height: 600px;
        padding: 16px;
    }

    .detail-section {
        margin-bottom: 16px;
    }

    .detail-section:last-child {
        margin-bottom: 0;
    }

    .detail-section h4 {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--muted-fg);
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 6px;
        padding: 6px 0;
    }

    .detail-row span:first-child {
        color: var(--muted-fg);
    }

    .detail-row span:last-child {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--secondary);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        transition: width 0.3s;
    }

    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }

    .tag {
        padding: 4px 10px;
        background: var(--muted);
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .recommendation-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .recommendation-item {
        padding: 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        transition: border-color 0.2s;
    }

    .recommendation-item:hover {
        border-color: var(--primary);
    }

    .recommendation-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .recommendation-title {
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .recommendation-body {
        font-size: 13px;
        color: var(--muted-fg);
        margin-bottom: 8px;
    }

    .recommendation-meta {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: var(--muted-fg);
        font-family: var(--font-mono);
    }

    .no-data {
        text-align: center;
        padding: 48px;
        color: var(--muted-fg);
    }

    @media (max-width: 1024px) {
        .analysis-grid {
            grid-template-columns: 1fr;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>AI Analysis</h1>
        <p>PACP 7.0 compliant predictive insights and maintenance recommendations</p>
    </div>
    <div class="page-actions">
        <button class="btn" onclick="generatePACPReport()">
            <i class="fas fa-file-pdf"></i>
            Generate PACP Report
        </button>
        <button class="btn btn-secondary" onclick="exportRiskMatrix()">
            <i class="fas fa-file-excel"></i>
            Export Risk Matrix
        </button>
    </div>
</div>

<!-- PACP Filters -->
<div class="filters-section">
    <h3>
        <i class="fas fa-filter"></i>
        Filter by Defect Type (PACP)
    </h3>
    <div class="filter-grid">
        <div class="filter-item">
            <input type="checkbox" id="filter-crack" value="crack" checked onchange="applyFilters()">
            <label for="filter-crack">Cracks (CL, CR, FR)</label>
        </div>
        <div class="filter-item">
            <input type="checkbox" id="filter-corrosion" value="corrosion" checked onchange="applyFilters()">
            <label for="filter-corrosion">Corrosion (COR)</label>
        </div>
        <div class="filter-item">
            <input type="checkbox" id="filter-deformation" value="deformation" checked onchange="applyFilters()">
            <label for="filter-deformation">Deformation (DEF)</label>
        </div>
        <div class="filter-item">
            <input type="checkbox" id="filter-deposit" value="deposit" checked onchange="applyFilters()">
            <label for="filter-deposit">Deposits (DEP)</label>
        </div>
        <div class="filter-item">
            <input type="checkbox" id="filter-root" value="root" checked onchange="applyFilters()">
            <label for="filter-root">Roots (RO)</label>
        </div>
    </div>
</div>

<!-- Summary Metrics -->
<div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr);">
    <div class="metric-card">
        <div class="metric-icon" style="background: rgba(198, 40, 40, 0.15);">
            <i class="fas fa-exclamation-triangle" style="color: var(--destructive);"></i>
        </div>
        <div class="metric-content">
            <div class="metric-value" id="critical-findings">-</div>
            <div class="metric-label">Critical Findings</div>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="background: rgba(237, 108, 2, 0.15);">
            <i class="fas fa-tools" style="color: var(--chart-2);"></i>
        </div>
        <div class="metric-content">
            <div class="metric-value" id="high-risk-segments">-</div>
            <div class="metric-label">High Risk Segments</div>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="background: rgba(25, 118, 210, 0.15);">
            <i class="fas fa-chart-line" style="color: var(--primary);"></i>
        </div>
        <div class="metric-content">
            <div class="metric-value" id="avg-confidence">-</div>
            <div class="metric-label">Avg Confidence</div>
        </div>
    </div>
</div>

<!-- Analysis Cards -->
<div class="analysis-grid">
    <!-- Corrosion Detection -->
    <div class="analysis-card">
        <h3>Corrosion Detection</h3>
        <p>PACP-coded defects with AI confidence scores</p>
        <div class="accordion" id="corrosion-accordion">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Maintenance Recommendations -->
    <div class="analysis-card">
        <h3>Maintenance Recommendations</h3>
        <p>Prioritized actions based on risk analysis</p>
        <div class="recommendation-list" id="recommendations-list">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let aiAnalyses = [];
    let allAnalyses = [];

    // PACP category mapping
    const pacpCategories = {
        'CL': 'crack', 'CR': 'crack', 'FR': 'crack',
        'COR': 'corrosion',
        'DEF': 'deformation',
        'DEP': 'deposit',
        'RO': 'root'
    };

    async function loadAnalyses() {
        try {
            const response = await fetch('/api/ai-analysis');
            allAnalyses = await response.json();
            aiAnalyses = allAnalyses;
            
            updateMetrics();
            renderAnalyses();
        } catch (error) {
            console.error('Error loading AI analyses:', error);
        }
    }

    function applyFilters() {
        const filters = {
            crack: document.getElementById('filter-crack').checked,
            corrosion: document.getElementById('filter-corrosion').checked,
            deformation: document.getElementById('filter-deformation').checked,
            deposit: document.getElementById('filter-deposit').checked,
            root: document.getElementById('filter-root').checked
        };

        aiAnalyses = allAnalyses.filter(analysis => {
            const code = analysis.pacp_code.split('-')[0];
            const category = pacpCategories[code];
            return filters[category];
        });

        updateMetrics();
        renderAnalyses();
    }

    function updateMetrics() {
        const criticalCount = aiAnalyses.filter(a => a.maintenancePriority === 'Critical').length;
        const highRiskCount = aiAnalyses.filter(a => a.maintenancePriority === 'Critical' || a.maintenancePriority === 'High').length;
        const avgConfidence = aiAnalyses.length > 0
            ? (aiAnalyses.reduce((sum, a) => sum + a.corrosionConfidence, 0) / aiAnalyses.length * 100).toFixed(1)
            : 0;

        document.getElementById('critical-findings').textContent = criticalCount;
        document.getElementById('high-risk-segments').textContent = highRiskCount;
        document.getElementById('avg-confidence').textContent = avgConfidence + '%';
    }

    function renderAnalyses() {
        const accordion = document.getElementById('corrosion-accordion');
        const recommendations = document.getElementById('recommendations-list');

        if (aiAnalyses.length === 0) {
            accordion.innerHTML = '<div class="no-data">No analyses match the selected filters</div>';
            recommendations.innerHTML = '<div class="no-data">No recommendations available</div>';
            return;
        }

        // Render accordion items
        accordion.innerHTML = aiAnalyses.map((analysis, index) => {
            const confidencePercent = (analysis.corrosionConfidence * 100).toFixed(2);
            const confidenceLevel = analysis.confidence_level;
            const confidenceBadge = getConfidenceBadge(confidenceLevel, confidencePercent);

            return `
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(${index})">
                        <div class="accordion-header-content">
                            <div>
                                <div class="accordion-title">${analysis.pipeSegmentName}</div>
                                <div class="pacp-info">
                                    <span class="pacp-code">${analysis.pacp_code}</span>
                                    <span class="pacp-score">Score: ${analysis.pacp_score}/5</span>
                                    <span class="badge badge-${analysis.maintenancePriority.toLowerCase()}">${analysis.maintenancePriority}</span>
                                    ${confidenceBadge}
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down accordion-icon" id="icon-${index}"></i>
                    </div>
                    <div class="accordion-content" id="content-${index}">
                        <div class="detail-section">
                            <h4>PACP Classification</h4>
                            <div class="detail-row">
                                <span>Code</span>
                                <span>${analysis.pacp_code}</span>
                            </div>
                            <div class="detail-row">
                                <span>Defect</span>
                                <span>${analysis.pacp_name}</span>
                            </div>
                            <div class="detail-row">
                                <span>Description</span>
                                <span>${analysis.pacp_description}</span>
                            </div>
                            <div class="detail-row">
                                <span>Location</span>
                                <span>${analysis.defect_location_meters}m from start</span>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>Risk Assessment</h4>
                            <div class="detail-row">
                                <span>Corrosion Level</span>
                                <span>${analysis.corrosionLevel}</span>
                            </div>
                            <div class="detail-row">
                                <span>AI Confidence</span>
                                <span>${confidencePercent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>Predicted Timeline</h4>
                            <div class="detail-row">
                                <span>Estimated Age</span>
                                <span>${analysis.estimatedFinancialAge} years</span>
                            </div>
                            <div class="detail-row">
                                <span>Predicted Failure</span>
                                <span>${analysis.predictedFailureMonths} months</span>
                            </div>
                        </div>

                        ${analysis.soilContaminationDetected && analysis.soilContaminationDetected.length > 0 ? `
                        <div class="detail-section">
                            <h4>Soil Contamination Detected</h4>
                            <div class="tags">
                                ${analysis.soilContaminationDetected.map(c => `<span class="tag">${c}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');

        // Render recommendations
        recommendations.innerHTML = aiAnalyses
            .sort((a, b) => {
                const priorityOrder = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
                return priorityOrder[b.maintenancePriority] - priorityOrder[a.maintenancePriority];
            })
            .map(analysis => `
                <div class="recommendation-item">
                    <div class="recommendation-header">
                        <div class="recommendation-title">
                            <span class="badge badge-${analysis.maintenancePriority.toLowerCase()}">${analysis.maintenancePriority}</span>
                            <span>${analysis.pipeSegmentName}</span>
                            <span class="pacp-code">${analysis.pacp_code}</span>
                        </div>
                    </div>
                    <div class="recommendation-body">
                        ${analysis.recommendations}
                    </div>
                    <div class="recommendation-meta">
                        <span>Age: ${analysis.estimatedFinancialAge} years</span>
                        <span>Failure: ${analysis.predictedFailureMonths} months</span>
                        <span>Location: ${analysis.defect_location_meters}m</span>
                    </div>
                </div>
            `).join('');
    }

    function getConfidenceBadge(level, percent) {
        const icons = {
            'high': 'check-circle',
            'medium': 'exclamation-circle',
            'low': 'exclamation-triangle'
        };
        const labels = {
            'high': 'HIGH CONFIDENCE',
            'medium': 'MEDIUM CONFIDENCE',
            'low': 'LOW - REVIEW NEEDED'
        };
        return `<span class="confidence-badge ${level}">
            <i class="fas fa-${icons[level]}"></i>
            ${percent}% ${labels[level]}
        </span>`;
    }

    function toggleAccordion(index) {
        const content = document.getElementById(`content-${index}`);
        const icon = document.getElementById(`icon-${index}`);
        
        content.classList.toggle('open');
        icon.classList.toggle('open');
    }

    function generatePACPReport() {
        alert('Generating PACP 7.0 Inspection Report...\n\nThis will create a PDF with:\n- All defect findings\n- PACP codes and scores\n- Risk assessments\n- Maintenance recommendations\n\nExport format: PDF, ARGON CSV, or Excel');
    }

    function exportRiskMatrix() {
        // Convert to CSV format
        const headers = ['Segment', 'PACP_Code', 'PACP_Score', 'Priority', 'Confidence', 'Failure_Months', 'Location_m'];
        const rows = aiAnalyses.map(a => [
            a.pipeSegmentName,
            a.pacp_code,
            a.pacp_score,
            a.maintenancePriority,
            (a.corrosionConfidence * 100).toFixed(2),
            a.predictedFailureMonths,
            a.defect_location_meters
        ]);

        const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pipevision-risk-matrix.csv';
        a.click();
    }

    // Load data on page load
    loadAnalyses();
</script>
{% endblock %}