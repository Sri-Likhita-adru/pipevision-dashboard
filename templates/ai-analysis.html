{% extends "base.html" %}

{% block extra_styles %}
<style>
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-top: 24px;
    }

    .analysis-card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
    }

    .analysis-card h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .analysis-card > p {
        font-size: 13px;
        color: var(--muted-fg);
        margin-bottom: 16px;
    }

    .accordion {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .accordion-item {
        border-bottom: 1px solid var(--border);
    }

    .accordion-item:last-child {
        border-bottom: none;
    }

    .accordion-header {
        padding: 16px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .accordion-header:hover {
        background: var(--muted);
    }

    .accordion-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .accordion-title {
        font-size: 14px;
        font-weight: 500;
    }

    .accordion-confidence {
        font-size: 12px;
        color: var(--muted-fg);
        font-family: var(--font-mono);
    }

    .accordion-icon {
        transition: transform 0.2s;
    }

    .accordion-icon.open {
        transform: rotate(180deg);
    }

    .accordion-content {
        padding: 0 16px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .accordion-content.open {
        max-height: 500px;
        padding: 16px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--secondary);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 4px;
    }

    .progress-fill {
        height: 100%;
        background: var(--chart-1);
        transition: width 0.3s;
    }

    .contamination-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }

    .contamination-tag {
        padding: 4px 10px;
        background: var(--muted);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
    }

    .recommendation-item {
        display: flex;
        gap: 12px;
        padding: 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 12px;
        transition: all 0.2s;
    }

    .recommendation-item:hover {
        background: var(--muted);
    }

    .recommendation-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .recommendation-icon.critical {
        background: rgba(198, 40, 40, 0.1);
        color: var(--destructive);
    }

    .recommendation-icon.high {
        background: rgba(237, 108, 2, 0.1);
        color: var(--chart-2);
    }

    .recommendation-icon.medium {
        background: rgba(25, 118, 210, 0.1);
        color: var(--chart-1);
    }

    .recommendation-content {
        flex: 1;
    }

    .recommendation-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .recommendation-title {
        font-size: 14px;
        font-weight: 500;
    }

    .recommendation-description {
        font-size: 13px;
        color: var(--muted-fg);
        margin-bottom: 8px;
    }

    .recommendation-meta {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: var(--muted-fg);
    }

    .recommendation-action {
        width: 32px;
        height: 32px;
        border: 1px solid var(--border);
        background: transparent;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        align-self: center;
    }

    .recommendation-action:hover {
        background: var(--muted);
    }

    @media (max-width: 1024px) {
        .analysis-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>AI Analysis Dashboard</h1>
    <p>Tier 2: Machine learning insights and predictive analytics</p>
</div>

<!-- Summary Metrics -->
<div class="metric-grid">
    <div class="card">
        <div class="card-header">
            <span class="card-title">Critical Findings</span>
            <i class="fas fa-exclamation-triangle card-icon" style="color: var(--destructive);"></i>
        </div>
        <div class="metric-value text-destructive" id="critical-count">0</div>
        <div class="metric-label">Require immediate attention</div>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="card-title">High Risk Segments</span>
            <i class="fas fa-chart-line card-icon" style="color: var(--chart-2);"></i>
        </div>
        <div class="metric-value" id="high-risk-count">0</div>
        <div class="metric-label">Monitored closely</div>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="card-title">Avg. Confidence</span>
            <i class="fas fa-shield-alt card-icon" style="color: var(--chart-1);"></i>
        </div>
        <div class="metric-value" id="avg-confidence">0%</div>
        <div class="metric-label">Analysis accuracy</div>
    </div>
</div>

<!-- Analysis Results -->
<div class="analysis-grid">
    <!-- Corrosion Detection -->
    <div class="analysis-card">
        <h3>Corrosion Detection Results</h3>
        <p>AI-powered visual analysis</p>
        <div id="corrosion-accordion" class="accordion">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Maintenance Recommendations -->
    <div class="analysis-card">
        <h3>Maintenance Recommendations</h3>
        <p>Prioritized action items</p>
        <div id="recommendations-list">
            <!-- Dynamic content -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let aiAnalysis = [];
    let pipeSegments = [];

    async function loadAnalysis() {
        try {
            const [analysisRes, segmentsRes] = await Promise.all([
                fetch('/api/ai-analysis'),
                fetch('/api/pipe-segments')
            ]);

            aiAnalysis = await analysisRes.json();
            pipeSegments = await segmentsRes.json();

            updateMetrics();
            renderCorrosionResults();
            renderRecommendations();
        } catch (error) {
            console.error('Error loading analysis:', error);
        }
    }

    function getPipeName(pipeSegmentId) {
        const pipe = pipeSegments.find(p => p.id === pipeSegmentId);
        return pipe ? pipe.name : 'Unknown';
    }

    function updateMetrics() {
        const criticalCount = aiAnalysis.filter(a => 
            a.corrosionLevel === 'Critical' || a.maintenancePriority === 'Critical'
        ).length;

        const highRiskCount = aiAnalysis.filter(a => 
            a.corrosionLevel === 'High' || a.maintenancePriority === 'High'
        ).length;

        const avgConfidence = aiAnalysis.length > 0
            ? (aiAnalysis.reduce((sum, a) => sum + parseFloat(a.corrosionConfidence), 0) / aiAnalysis.length).toFixed(1)
            : 0;

        document.getElementById('critical-count').textContent = criticalCount;
        document.getElementById('high-risk-count').textContent = highRiskCount;
        document.getElementById('avg-confidence').textContent = avgConfidence + '%';
    }

    function renderCorrosionResults() {
        const accordion = document.getElementById('corrosion-accordion');
        const corrosionResults = aiAnalysis
            .filter(a => a.corrosionLevel !== 'None')
            .slice(0, 5);

        if (corrosionResults.length === 0) {
            accordion.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--muted-fg);">No corrosion detected</div>';
            return;
        }

        accordion.innerHTML = corrosionResults.map((analysis, index) => {
            const badgeClass = analysis.corrosionLevel.toLowerCase();
            return `
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(${index})">
                        <div class="accordion-header-content">
                            <span class="badge badge-${badgeClass}">${analysis.corrosionLevel}</span>
                            <span class="accordion-title">${getPipeName(analysis.pipeSegmentId)}</span>
                            <span class="accordion-confidence">${analysis.corrosionConfidence}% confidence</span>
                        </div>
                        <i class="fas fa-chevron-down accordion-icon" id="icon-${index}"></i>
                    </div>
                    <div class="accordion-content" id="content-${index}">
                        <div style="margin-bottom: 12px;">
                            <p style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Confidence Level</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${analysis.corrosionConfidence}%;"></div>
                            </div>
                        </div>
                        ${analysis.soilContaminationDetected && analysis.soilContaminationDetected.length > 0 ? `
                            <div style="margin-bottom: 12px;">
                                <p style="font-size: 13px; font-weight: 500; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-tint"></i>
                                    Soil Contamination Detected
                                </p>
                                <div class="contamination-tags">
                                    ${analysis.soilContaminationDetected.map(c => `<span class="contamination-tag">${c}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${analysis.predictedFailureMonths ? `
                            <div style="padding-top: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: var(--muted-fg);">Predicted Failure</span>
                                <span class="mono" style="font-weight: 500;">${analysis.predictedFailureMonths} months</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderRecommendations() {
        const list = document.getElementById('recommendations-list');
        const recommendations = aiAnalysis
            .filter(a => a.maintenancePriority !== 'Low')
            .sort((a, b) => {
                const priority = { Critical: 4, High: 3, Medium: 2, Low: 1 };
                return priority[b.maintenancePriority] - priority[a.maintenancePriority];
            })
            .slice(0, 6);

        if (recommendations.length === 0) {
            list.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--muted-fg);">No recommendations at this time</div>';
            return;
        }

        list.innerHTML = recommendations.map(analysis => {
            const priorityClass = analysis.maintenancePriority.toLowerCase();
            const recommendation = analysis.recommendations && analysis.recommendations.length > 0 
                ? analysis.recommendations[0] 
                : 'Schedule routine inspection';

            return `
                <div class="recommendation-item">
                    <div class="recommendation-icon ${priorityClass}">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="recommendation-content">
                        <div class="recommendation-header">
                            <span class="recommendation-title">${getPipeName(analysis.pipeSegmentId)}</span>
                            <span class="badge badge-${priorityClass}">${analysis.maintenancePriority}</span>
                        </div>
                        <p class="recommendation-description">${recommendation}</p>
                        <div class="recommendation-meta">
                            <span>Age: ${analysis.estimatedFinancialAge}y</span>
                            ${analysis.predictedFailureMonths ? `<span>Est. failure: ${analysis.predictedFailureMonths}mo</span>` : ''}
                        </div>
                    </div>
                    <button class="recommendation-action">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }).join('');
    }

    function toggleAccordion(index) {
        const content = document.getElementById(`content-${index}`);
        const icon = document.getElementById(`icon-${index}`);
        
        const isOpen = content.classList.contains('open');
        
        // Close all accordions
        document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('open'));
        document.querySelectorAll('.accordion-icon').forEach(i => i.classList.remove('open'));
        
        // Open clicked accordion if it was closed
        if (!isOpen) {
            content.classList.add('open');
            icon.classList.add('open');
        }
    }

    // Load data on page load
    loadAnalysis();
</script>
{% endblock %}